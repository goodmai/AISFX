## Анализ Структуры и Функционала Приложения

На основе предоставленных файлов кода на Scala, можно выделить следующую структуру и функционал приложения:

### Структура Проекта (Packages)

Проект организован по следующим пакетам, что соответствует стандартным практикам разделения ответственности:

* **`com.aiplatform.app`**:
    * Содержит точку входа приложения (`MainApp.scala`). Отвечает за инициализацию UI (JavaFX/ScalaFX), создание `ActorSystem` (Pekko Actors) и основного контроллера (`MainController`).
* **`com.aiplatform.controller`**:
    * Содержит `MainController.scala`. Реализует основную логику управления приложением, связывая UI (View), модели данных (Model) и сервисы. Обрабатывает действия пользователя (нажатия кнопок, ввод текста), управляет состоянием приложения (`AppState`), взаимодействует с AI сервисом и управляет пресетами и настройками.
* **`com.aiplatform.model`**:
    * Определяет структуры данных (case-классы), используемые в приложении:
        * `AppState.scala`: Центральное хранилище состояния приложения (топики, активный топик, настройки AI, пресеты, настройки UI).
        * `Topic.scala`: Представляет отдельный диалог (топик) с его сообщениями, заголовком, категорией и метаданными.
        * `Dialog.scala`: Представляет один ход диалога (запрос + ответ + метаданные).
        * `PromptPreset.scala`: Определяет шаблон (пресет) для запросов к AI, включая сам промпт и параметры генерации.
        * `ModelInfo.scala`: Информация о доступных AI моделях.
        * `Section.scala`: Перечисление для секций приложения (устаревшее, судя по остальному коду).
* **`com.aiplatform.repository`**:
    * Отвечает за сохранение и загрузку состояния приложения (`AppState`).
    * `StateRepository.scala`: Реализует логику сохранения/загрузки состояния в/из JSON файла (`app_state.json`).
* **`com.aiplatform.service`**:
    * Содержит сервисы, инкапсулирующие специфическую логику:
        * `AIService.scala`: Взаимодействует с Google Generative AI API (Gemini) для отправки запросов и получения ответов. Формирует запросы с учетом истории диалога и параметров пресета.
        * `ModelFetchingService.scala`: Загружает список доступных AI моделей от Google API.
        * `HistoryService.scala`: Актер Pekko, изначально, вероятно, предназначавшийся для управления историей, но в текущей версии его функционал упрощен (только логирование событий). Управление историей (списком топиков) теперь централизовано в `MainController` и `AppState`.
* **`com.aiplatform.util`**:
    * Содержит утилитарные классы.
    * `JsonUtil.scala`: Утилиты для сериализации/десериализации объектов в/из JSON с использованием библиотеки `upickle`.
* **`com.aiplatform.view`**:
    * Содержит компоненты пользовательского интерфейса (UI), построенные с использованием ScalaFX:
        * `Header.scala`: Верхняя панель с кнопками категорий ("Research", "Code", "Settings" и т.д.).
        * `HistoryPanel.scala`: Левая панель для отображения списка топиков (диалогов) текущей категории. Позволяет выбирать и удалять топики.
        * `RequestArea.scala`: Нижняя панель с полем для ввода текста запроса и кнопками "Отправить" и "Новый топик".
        * `ResponseArea.scala`: Центральная область для отображения переписки (запросов и ответов AI) в выбранном топике.
        * `SettingsView.scala`: Модальное окно для настройки параметров приложения (API ключ, глобальная модель AI, шрифты, управление пресетами, назначение пресетов кнопкам хедера).
        * `LeftPanel.scala`: Вероятно, устаревший компонент, так как навигация по секциям теперь реализована через `Header`.
        * `DialogUtils.scala` (Внутри `SettingsView.scala`): Утилиты для отображения стандартных диалоговых окон (предупреждения, подтверждения, ошибки).

### Основной Функционал

1.  **Взаимодействие с AI (Gemini)**:
    * Отправка текстовых запросов к AI модели Google Gemini.
    * Использование API ключа для аутентификации.
    * Поддержка истории диалога: предыдущие сообщения передаются в API для контекста.
    * Настройка параметров генерации AI (temperature, topP, topK) через пресеты или глобальные настройки.
    * Автоматическая загрузка списка доступных моделей AI от Google.
2.  **Управление Диалогами (Топиками)**:
    * Организация диалогов по категориям, соответствующим кнопкам в хедере ("Research", "Code", etc.).
    * Создание новых топиков.
    * Просмотр истории сообщений в выбранном топике.
    * Переключение между топиками в рамках одной категории.
    * Удаление топиков.
    * Автоматическая генерация заголовка для нового топика на основе первого запроса (с использованием отдельной, быстрой модели AI).
3.  **Управление Пресетами**:
    * Использование предопределенных (стандартных) и пользовательских пресетов промптов.
    * Каждый пресет содержит текст промпта (с плейсхолдером `{{INPUT}}`) и параметры генерации (температура, topP, topK), а также может переопределять глобальную модель AI.
    * Редактирование стандартных и пользовательских пресетов (кроме имени стандартных).
    * Создание и удаление пользовательских пресетов.
4.  **Настройки Приложения**:
    * Настройка API ключа Gemini.
    * Выбор глобальной модели AI, используемой по умолчанию.
    * Назначение пресетов кнопкам категорий в хедере.
    * Настройка шрифта (семейство и размер) - применение к UI не полностью реализовано, но настройки сохраняются.
5.  **Сохранение Состояния**:
    * Автоматическое сохранение всего состояния приложения (список топиков, активный топик, настройки, пресеты, маппинги кнопок) в локальный JSON файл (`app_state.json`) при изменениях и при закрытии приложения.
    * Загрузка состояния при старте приложения.
6.  **Пользовательский Интерфейс (ScalaFX)**:
    * Графический интерфейс, построенный с использованием ScalaFX.
    * Интерфейс разделен на логические компоненты (`Header`, `HistoryPanel`, `ResponseArea`, `RequestArea`, `SettingsView`).
    * Использование Pekko Actors (`HistoryService`) для потенциальной асинхронной обработки, хотя его текущая роль минимальна. Асинхронность в основном реализуется через `Future` в `MainController`, `AIService`, `ModelFetchingService`.

### Краткое Резюме

Это десктопное приложение на Scala/ScalaFX, выступающее в роли клиента для Google Generative AI (Gemini). Оно позволяет пользователю вести множество тематических диалогов с AI, организованных по категориям. Приложение поддерживает настройку промптов и параметров генерации через систему пресетов, а также сохраняет всю историю и настройки локально. Структура кода следует паттерну, близкому к MVC, с четким разделением на модели данных, UI (View), контроллер и сервисы. Асинхронные операции (запросы к API) выполняются с использованием `Future` и `Pekko HTTP`.